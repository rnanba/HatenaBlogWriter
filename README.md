# HatenaBlogWriter (v0.6)

## 概要

はてなブログ用の[「はてなダイアリーライター」](http://www.hyuki.com/techinfo/hatena_diary_writer.html) 的なコマンドラインツール。

## 必要なもの

- ruby (たぶん 2.0 以降)
- atomutil (0.1.4)

## 使用法

### はてなブログの設定

はてなブログの [設定 - 基本設定 - 編集モード] で、「はてな記法モード」を設定してください(他のモードでの動作は未確認)。

### 設定

カレントディレクトリの ``config.yml`` に以下のように設定します。

```yaml:config.yml
id: your_hatena_id
blog_domain: your_blog.hatenablog.com
api_key: your_api_key
```

API Key は、はてなブログの [設定 - 詳細設定 - AtomPub - APIキー] に表示されている文字列を記入します。

API Key が第三者の手に渡ると、第三者によるブログの改竄や削除が可能になってしまいます。``config.yml`` をネット等に公開しないように注意してください。

### エントリファイルの作成(new サブコマンド)

エントリファイルを作成するには以下のコマンドを実行します。

```shell-session:
$ hbw.rb new
OK: エントリファイル '2017-02-12_01.txt' を作成しました。
$
```

``{今日の日付}_{連番}.txt`` 形式のファイル名でエントリファイルが作成されます。

### エントリファイルの編集

以下のような書式でエントリファイルを記述して、文字エンコーディングに UTF-8 を指定して保存します。

```none:2017-02-12_01.txt
title: サンプルエントリ
date: 2017-02-12
category: プログラミング, はてな
draft: no

ここから本文です。
はてな記法で記述します。
この記事は投稿時に公開されます。

```

ヘッダの意味は以下の通りです。

|ヘッダ|意味・書き方|
|:---|:---|
|title  |エントリのタイトルです。|
|date   |エントリの日付です。日付として表示される日時を「2017-02-12 01:56:00 +0900」のように記述します。時間やタイムゾーンは省略可能です。|
|category|エントリのカテゴリです。複数のカテゴリを設定する場合は「,」(カンマ)区切りで列挙します。|
|draft|記事を下書きにするか公開するかを指定します。「yes」を指定すると下書きに、「no」を指定すると公開になります。省略した場合は公開になります。|

### 投稿

``hbw.rb`` を引数なしで実行すると、カレントディレクトリにある新規エントリをすべて投稿します。

```shell-session:
$ hbw.rb
新規エントリファイルが 1 件あります。
OK: 2017-02-12_01.txt: エントリを投稿しました。
$
```

HatenaBlogWriter は、カレントディレクトリにあるファイルで、以下の条件を全て満たすものを新規エントリファイルとみなします。

- ``{日付}_{番号}.txt`` 形式のファイル名を持つファイル
- data ディレクトリに対応する投稿データファイル(``{エントリファイル名}.dat``)が存在しないファイル

### 更新

一度投稿したエントリファイルの内容を修正してから、``hbw.rb`` を引数なしで実行すると、修正したすべてのエントリファイルについて、それぞれの投稿先のエントリが更新されます。

```shell-session:
$ hbw.rb
新規エントリファイルはありません。
修正されたエントリファイルが 1 件あります。
OK: 2017-02-12_01.txt: エントリを更新しました。
$
```

HatenaBlogWriter は、カレントディレクトリにあるファイルで、以下の条件を全て満たすものを修正されたエントリファイルとみなします。

- data ディレクトリに対応する投稿データファイル(``{エントリファイル名}.dat``)がある
- ファイルの更新日時が投稿データファイルに記録された最終更新日時より新しい
- ファイルの内容が実際に変更されている(SHA1ハッシュが投稿データファイルに記録されている投稿・更新時点でのSHA1ハッシュと一致しない)

エントリファイルの内容比較では、ヘッダの順番や余計な空白や改行の変更は無視されます。

## 高度な(?)使い方
### post サブコマンド

エントリファイルを直接指定して投稿するには ``post`` サブコマンドを使用します。

```shell-session:
$ hbw.rb post my_entry.txt
OK: my_entry.txt: エントリを投稿しました。
$
```

### update サブコマンド

エントリファイルを直接指定して更新するには ``update`` サブコマンドを使用します。

```shell-session:
$ hbw.rb update my_entry.txt
OK: my_entry.txt: エントリを更新しました。
$
```

### check サブコマンド

実際には投稿・更新せずに、新規エントリファイルや修正されたエントリファイルを確認するには ``check`` サブコマンドを使用します。

```shell-session:
$ hbw.rb check
新規エントリファイルが 1 件あります。
2017-02-13_01.txt
修正されたエントリファイルが 1 件あります。
2017-02-12_01.txt
$
```

### version サブコマンド

hb.rb のバージョンを確認するには ``version`` サブコマンドを使用します。

```shell-session:
$ hbw.rb version
HatenaBlogWriter v0.2
$
```

## 注意事項

- v0.5 まででエントリ本文に書かれた文字実体参照(&amp;lt;等)が投稿されたデータ内で展開済の文字に置き換えられてしまうバグがありました。このバグの影響を受けた投稿済みエントリの修復は v0.6 以降で update サブコマンドを使って当該エントリのエントリファイルを指定してエントリを直接更新してください。
- v0.2〜v0.3 で投稿・更新した際、投稿データファイルにSHA1ハッシュに間違った値が記録されるバグがありました。エントリファイルを修正して更新しようとした時に「{ファイル名} の内容は前回投稿したものと同じでした。」の表示が出て修正済みファイルと認識されなくなった場合は ``fix_data`` サブコマンド(引数なし)を実行して投稿データファイルを修正してください。
- 投稿先のエントリの内容はチェックしていません。最初の投稿後、はてなブログの編集画面で更新したエントリでも、警告無く上書きします。
- エントリファイルのあるディレクトリの下に ``data`` ディレクトリを作成します。この下に投稿済みエントリの投稿データファイル(拡張子 .dat のファイル)が保存されます。消さないようにしてください。
- v0.2 から投稿時にエントリファイルの末尾に投稿済み情報を書き込まないように仕様を変更しました。v0.1 で投稿したファイルは v0.2 では新規エントリファイルとして扱われます。
- draft ヘッダを更新して下書きを公開することはできますが、公開したエントリを下書きに戻すことはできません。下書きに戻すにははてなブログの編集画面から設定してください。

## TODO

- 投稿先エントリの更新日時をチェックして上書きを抑止する機能
- 投稿先のエントリの更新日時をチェックしてエントリファイルと同期する機能
- v0.1 のエントリファイルから v0.2 形式への移行機能(要望があれば)
