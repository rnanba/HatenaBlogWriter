# HatenaBlogWriterDownloader (v0.1.1)

## 概要

はてなブログで新規作成・更新したエントリを HatenaBlogWriter のエントリファイルの形式でダウンロードするコマンドラインツール。

## 必要なもの

- ruby (たぶん 2.0 以降)
- atomutil (0.1.5 以降)
  - 0.1.4 では正常に動作しません。

## 使用法

### 前提条件

- 新規作成・更新されたエントリが、はてな記法モードで書かれていること。
- HatenaBlogWriter の設定が完了していること(参照: README.md/設定)。

### 最近のエントリのダウンロード

hbwdl.rb を引数なしで起動すると、サーバにある最近の7件のエントリをチェックして、HatenaBlogWriter で投稿されていないエントリがあれば、エントリファイルを作成してダウンロードします。

```shell-session:
$ hbwdl.rb
---
title: Webから作成したエントリ(その5)
URL: http://rna.hatenadiary.jp/entry/2019/01/28/180033
sha1: 1f19f9b36b3bfdba2c68d5f6df1c2ae3cca598d2
新規エントリです。
OK: 2019-01-28_03.txt: エントリファイルを作成しました。
```

HatenaBlogWriter で投稿されたエントリで、サーバ上のエントリの内容とローカルのエントリファイルの内容が一致しないエントリがあれば、ユーザにエントリファイルを更新するかどうかを尋ねます。'yes' を入力するとエントリファイルを更新します。更新前の内容は ``{エントリファイル名}.{番号}`` 形式のバックアップファイルに残されます。

```shell-session:
---
title: Webから作成したエントリ(その4)
URL: http://rna.hatenadiary.jp/entry/2019/01/28/180138
sha1: 2534647c14915e618a3120f77b4cb8e4c60915b7
既存のエントリです: 2019-01-28_02.txt
変更があります。
エントリファイルをリモートの内容で更新しますか? (yes/No)
yes
OK: 2019-01-28_02.txt: エントリファイルを更新しました。
```

サーバ上のエントリの内容とローカルのエントリファイルの内容が一致する場合はその旨表示するだけで何もしません。

```shell-session:
---
title: id記法のリンクの修正 & お詫び
URL: http://rna.hatenadiary.jp/entry/2019/01/28/034900
sha1: 01d0993a938406d8e53fb3551442a058b1e8f265
既存のエントリです: 2019-01-28_01.txt
変更はありません。
```

### 件数を指定してダウンロード

最近の7件より古いエントリをダウンロードするには引数に適当な件数を指定して起動します。20件まで遡ってダウンロードするなら引数に ``20`` を指定します。

```shell-session:
$ hbwdl.rb 20
```

### 全件ダウンロード

引数に ``0`` を指定すると遡れる限りの全てのエントリをダウンロードします。

**注意** : 全件ダウンロードはサーバに過剰な負荷がかかるおそれがあります。日常的に実行することは避けてください。

### バージョンの確認

hbwdl.rb のバージョンを確認するには引数に ``version`` を指定してください。

```shell-session:
$ hbwdl.rb version
HatenaBlogWriterDownloader v0.1
$
```

### エラーについて

まれにサーバから取得したエントリデータの解析に失敗する場合があります。その場合は以下のようなエラーを表示して、そのエントリのダウンロードをスキップします。

```shell-session:
---
title:  ping 送信しないテスト(hw.pl 1.0.1)
エントリの解析に失敗しました。: invalid date: "0001-01-01T00:00:00+09:18:59"
```

ダウンロードされていないエントリがある場合はコンソール出力を遡ってエラーになっていないか確認してください。

## 注意事項

- v0.1 では一度もエントリを投稿していない状態で hbwdl.rb を実行するとエラーになるというバグがありました。このバグでエントリのダウンロードに失敗した場合、エントリファイルが1件ダウンロードされた状態になりますが、そのファイルを削除してから v0.1.1 以降で再度エントリをダウンロードしてください。
  - ここでエントリファイルを削除しない場合、そのファイルを hbw.rb が新規エントリファイルと誤認してしまいます。

## 制限事項

- はてなの AtomPub の feed に含まれないエントリはダウンロードできませ
  ん。2019/1/28 現在、一部のエントリ(西暦1年日付のエントリ等)が feed
  に含まれない場合があるようです。
- はてなの AtomPub の feed に更新日時が誤ったフォーマットで記述された
  エントリが含まれることがあります。そのようなエントリはダウンロード
  できません(「エントリの解析に失敗しました。」のエラーになります)。
